# 동기화

# 목차

## 동기화란

정의 : 동기화는 여러 스레드나 프로세스가 **동시에 공유 자원에 접근**할 때, 그 자원에 대한 **충돌을 방지**하는 메커니즘이다. 

목적 : 임계 구역을 보호하여 **데이터의 일관성** 및 **무결성**을 보장하는 것이 목표이다. 동기화가 없으면 스레드들이 임계 구역을 동시에 수정해 데이터 손상이나 예기치 못한 결과가 발생할 수 있다. 

![데이터 무결성이 깨지는 예시 ](https://prod-files-secure.s3.us-west-2.amazonaws.com/be0198d7-dcc4-468c-b22d-abd7eefc4914/09669cf1-ee46-4f6a-ac20-7a227ca0e4e7/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2024-10-17_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_7.48.48.png)

데이터 무결성이 깨지는 예시 

*데이터 무결성 : 데이터의 정확성, 일관성, 유효성이 유지되는 것을 의미한다.*

이를 위해 세 가지 동기화 도구들이 사용된다.

- 스핀락
- 뮤텍스
- 세마포어

## 스핀락

정의 : 스핀락은 임계 구역에 진입하기 위해 잠금을 시도하는 동안 CPU를 계속해서 사용하면서 잠금 상태를 확인하는 동기화 기법이다. 

![스핀락 작동 예시 ](https://prod-files-secure.s3.us-west-2.amazonaws.com/be0198d7-dcc4-468c-b22d-abd7eefc4914/f4247fa9-c49a-4cca-955f-e800dc23ad22/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2024-10-17_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_7.50.53.png)

스핀락 작동 예시 

- *락 변수 : 스레드들이 임계 영역이 진입할 수 있는지 여부를 제어하는 역할을 말한다.*
- *임계 구역 : 멀티 스레드 or 멀티 프로세스 환경에서 공유 자원에 접근하는 코드 영역을 말한다.*

### 작동 방식

- 스레드가 임계 구역에 진입하려고 시도할 때, 잠금(lock)을 얻을 수 있을 때까지 계속해서 잠금 상태를 확인한다. 만약 잠금을 얻지 못하면 스레드는 반복적으로 잠금 상태를 확인하며 CPU를 소모한다.(즉, 스핀하게 된다.)
- 잠금을 얻으면 임계 구역에 진입하여 작업을 수행하고, 임계 구역에서 빠져나올 때 잠금을 해제한다.

### 장단점

- 장점 : 문맥 전환(context switch)이 없으므로 매우 빠르다. 특히 잠금이 짧은 시간 동안 유지되는 경우에 유리하다.
- 단점 : 잠금 시간이 길어지면 그만큼 CPU 자원을 계속 사용하기 때문에 비효율적이다. 특히 멀티 프로세스에서 많이 사용된다.

## 뮤텍스

정의 : 뮤텍스는 한 번에 하나의 스레드만 임계 구역에 접근할 수 있도록 제어하는 잠금 메커니즘이다. 뮤텍스는 상호 배제(Mutual Exclusion)를 의미한다. 

![탈의실이 하나 밖에 없는 작은 옷가게의 탈의실은 뮤텍스와 닮았다. ](https://prod-files-secure.s3.us-west-2.amazonaws.com/be0198d7-dcc4-468c-b22d-abd7eefc4914/d19953fc-12eb-4c3b-95a4-e3562847a299/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2024-10-18_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_10.22.05.png)

탈의실이 하나 밖에 없는 작은 옷가게의 탈의실은 뮤텍스와 닮았다. 

### 작동 방식

- 스레드는 임계 구역에 들어가기 전에 뮤텍스를 잠그고(lock) 나올 때 뮤텍스를 해제한다.(unlock)
- 뮤텍스가 잠겨 있으면, 다른 스레드는 임계 구역에 진입할 수 없으며, 잠금이 해제될 때까지 대기해야 한다. 대기 중인 스레드는 CPU를 사용하지 않고, 운영체제에 의해 블락(block) 상태로 전환된다.

### 장단점

- 장점 : CPU 자원을 소모하지 않고, 스레드가 블록 상태로 전환되기 때문에 비효율성을 줄일 수 있다.
- 단점 : 문맥 전환에 비용이 들 수 있다. 또한 데드락이나 우선순위 역전 문제가 발생할 수 있다.

*데드락 : 여러 프로세스 또는 스레드가 서로 자원을 기다리며 영원히 대기 상태에 빠지는 상황을 말한다.*

## 세마포어

정의 : 세마포어는 주어진 수만큼의 스레드가 임계 구역에 접근할 수 있도록 제어하는 동기화 도구이다. 주로 여러 자원을 동시에 관리할 때 사용된다. 

![대형 유니클로 매장과 같이 탈의실이 여러개 있을 수 있는 것이 세마포어와 닮았다.](https://prod-files-secure.s3.us-west-2.amazonaws.com/be0198d7-dcc4-468c-b22d-abd7eefc4914/0607c181-fe54-494c-be50-b2687bb5a090/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2024-10-18_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_10.27.54.png)

대형 유니클로 매장과 같이 탈의실이 여러개 있을 수 있는 것이 세마포어와 닮았다.

### 종류

- 이진 세마포어 : 뮤텍스와 유사하게 0과 1만 가질 수 있다. 한 번에 하나의 스레드만 임계 구역에 접근할 수 있다.
- 개수 세마포어 : 0 이상 임의의 정수 값을 가질 수 있는 세마포어이다. 한 번에 하나의 스레드만 임계 구역에 접근할 수 있다. 세마포어의 값이 자원의 개수에 해당하며, 자원이 부족하면 스레드가 대기상태로 전환된다.

### 작동 방식

- 세마포어는 `wait(P)`와 `signal(V)` 연산을 통해 작동한다.
- `wait`  연산은 세마포어의 값을 감소시키고 자원을 요청한다. 0 이하로 내려가면 스레드를 대기 상태로 만든다.
- `signal` 연산은 임계 구역에서 벗어날 때 사용한다. 세마포어의 값을 증가시켜 대기 중인 스레드가 깨어나 자원에 접근할 수 있도록 한다.

### 장단점

- 장점 :
    - 여러 스레드가 임계 구역에 접근할 수 있도록 하면서도 자원의 한계를 설정할 수 있다.
    - 스레드가 세마포어 소유권을 가지고 있지 않아서, 유연성이 높다.
- 단점 : 세마포어를 관리하는 코드에서 실수로 인해 자원을 적절하게 관리하지 못하면 데드락 또는 자원누수가 발생할 수 있다.

## 비교 분석

|  | **스핀락 (Spinlock)** | **뮤텍스 (Mutex)** | **세마포어 (Semaphore)** |
| --- | --- | --- | --- |
| **대기 방식** | 바쁜 대기 (busy-waiting) | 블로킹 (blocking) | 블로킹 (blocking) |
| **사용 시점** | 짧은 임계 구역 | 긴 임계 구역 | 여러 자원이 있는 상황 |
| **CPU 사용** | 지속적으로 사용 | 사용하지 않음 | 사용하지 않음 |
| **소유권** | 있음 | 있음 | 없음 |
| **컨텍스트 스위칭** | 없음 | 있음 | 있음 |
| **유연성** | 낮음 | 중간 | 높음 |

## 면접 질문

- 경쟁상태 해결방법은 무엇이 있고 각각에 대해 설명해주세요.
- 뮤텍스와 세마포어의 차이점이 무엇인가요?
- 스핀락 대신 뮤텍스를 사용하는 것이 더 나은 상황은 어떤 경우인가요?

## 참고자료

- [경쟁상태, 임계영역의 개념과 동기화를 위한 여러 상호배제 기법 (mutex, semaphore, monitor)](https://hudi.blog/race-condition-critical-section-mutual-exclusion/)
- [[운영체제] 6. 스레드 동기화](https://velog.io/@passion_man/%EC%9A%B4%EC%98%81%EC%B2%B4%EC%A0%9C-6.-%EC%8A%A4%EB%A0%88%EB%93%9C-%EB%8F%99%EA%B8%B0%ED%99%94)